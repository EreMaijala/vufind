<?
  // Set page title.
  $this->headTitle($this->translate('E-version') . ': ' . $this->driver->getBreadcrumb());
?>
<? if ($this->linksFrom856): ?>
	<div class='field856'>
		<table class='table'>
			<tr>
				<th><?=$this->translate('Destination');?></th>
				<th><?=$this->translate('Accessibility');?></th>
				<th><?=$this->translate('Link');?></th>
				<th><?=$this->translate('Distributor');?></th>
			</tr>
			<? foreach ($this->linksFrom856 as $linkRawString): 
				$link = explode("|", $linkRawString);
				$anchor = ! empty($link[3]) ? $link[3] : $this->transEsc('Link');
				$destination = (substr($link[0], 0, 4) === 'kram') ? $this->translate('Digital library') : $this->translate('Web');
				$title = ! empty($link[3]) ? $link[3] : $destination;
				$statusClass = ($link[1] === 'online') ? 'success' : ($link[1] === 'unknown') ? 'warning' : 'danger';
			?>
				<tr>
					<td><?=$destination?></td>
					<? if ($link[1] === 'protected') : ?>
					 <td>
					 	<a target='_blank' data-toggle="tooltip" data-placement="top" title="<?=$this->translate('What does it mean?')?>" href='https://cs.wikipedia.org/wiki/Voln%C3%A9_d%C3%ADlo'>
					 		<span class="label label-<?=$statusClass?>"><?=$this->transEsc('link_access_status_'.$link[1])?></span>
					 	</a>
					 </td>
					<? else : ?>
					<td><span class="label label-<?=$statusClass?>"><?=$this->transEsc('link_access_status_'.$link[1])?></span></td>
					<? endif; ?>
					<td><a title='<?=$title?>' href='<?=$link[2]?>'><?=$anchor?></a></td>
					<td><?=$this->transEsc('source_'.$link[0])?></td>
				</tr>
			<? endforeach; ?>
		</table>
	</div>
<? endif; ?>
<div id='sfx-jib-ajax-result'></div>

<script src="/themes/cpk-devel/js/ajax-record-tabs.js"></script>
<script>

	function extractDomain( url )
	{
	    var domain;
	    
	    //find & remove protocol (http, ftp, etc.) and get domain
	    if (url.indexOf("://") > -1) {
	        domain = url.split('/')[2];
	    } else {
	        domain = url.split('/')[0];
	    }
	
	    //find & remove port number
	    domain = domain.split(':')[0];
	
	    return domain;
	}

	jQuery( document ).ready( function( $ ) {

		
		var arrayOf866 = get866( '<?= $this->driver->getParentRecordID() ?>' )['data'][0]['field866'];
		console.log('Pole 866: '+arrayOf866);

		if ( typeof sfxJibResult == "undefined" )
			var sfxJibResult = getSfxJibResult('http://sfx.jib.cz/sfxlcl3', '<?= $this->driver->getUniqueID() ?>', 'ANY');

		if ( sfxJibResult.data[0].sfxResult.targets.target !== '' ) {
			for (var i = 0; i < sfxJibResult.data[0].sfxResult.targets.target.length; i++) {
				var targetServiceId = sfxJibResult.data[0].sfxResult.targets.target[i].target_service_id;
				if( $.inArray(targetServiceId, arrayOf866) != -1) {
					var url = sfxJibResult.data[0].sfxResult.targets.target[i].target_url;
					$( "#sfx-jib-ajax-result" ).append( "<a href='"+url+"'>"+extractDomain(url)+"</a>" + '<br>' );
				}
			}
		}
		
	});
</script>
