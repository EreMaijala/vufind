<?php 
    $count = count($records);
?>

<span class='records-in-libraries-title'>
	<?=$this->translate('Found in') ?>
    <?=$count?>
    <?=$this->translate('institutions-in-locale') ?>
</span>

<div class="col-sm-12 dedupInformation">
<?php
	// put caslin at the end and cnb before caslin, when available
	// but keep at the front when is set in facet params
	$filters = $params->getFilters();
	
	$caslinFoundInFilters = 0;
	$cnbFoundInFilters = 0;
	
	$institutionsInFilters = [];
	if (isset($filters['~institution'])) {
    	$institutionsInFilters = $filters['~institution'];
	} else if (isset($filters['institution'])) {
	    $institutionsInFilters = $filters['institution'];
	}
	
	if(count($institutionsInFilters)) {
    	foreach($institutionsInFilters as $institution) {
    	    if (strpos($institution,'CASLIN') !== false) {
    	        $caslinFoundInFilters++;
    	    }
    	    if (strpos($institution,'CNB') !== false) {
    	        $cnbFoundInFilters++;
    	    }
    	    
    	}
	}
	
	if ($cnbFoundInFilters == 0) {
	    if (isset($records['cnb'])) {
	        $cnb = $records['cnb'];
	        unset($records['cnb']);
	        $records['cnb'] = $cnb;
	    }
	}
	
	if ($caslinFoundInFilters == 0) {
	    if (isset($records['caslin'])) {
	        $caslin = $records['caslin'];
	        unset($records['caslin']);
	        $records['caslin'] = $caslin;
	    }
	}
	
	// Institutes in filters will be on top of the list
	$institutionsMappings = [];
	if ($this->institutionsMappings) {
    	foreach ($this->institutionsMappings as $key => $value) {
    	    $institutionsMappings[md5($value)] = $key;
    	}
	}
	
	foreach ($institutionsInFilters as $institution) {
	    if (isset($institutionsMappings[md5($institution)])) {
	        if (array_key_exists($institutionsMappings[md5($institution)], $records)) {
	            $tempValue = $records[$institutionsMappings[md5($institution)]];
	            $tempKey = $institutionsMappings[md5($institution)];
	            $tempArray[$tempKey] = $tempValue;
	            unset($records[$institutionsMappings[md5($institution)]]);
	            $records = $tempArray + $records;
	            unset($tempArray);
	        }
	    }
	}
	
	// When selected town, select all intitutes in that town a put theme in 
	// the front of the list
	$institutionsInTowns = [];
	foreach ($institutionsInFilters as $institution) {
	    $parts = explode("/", $institution);
	    if(empty($parts[3])) {
	        if(! empty($parts[2])) {
	            foreach ($this->institutionsMappings as $key => $value) {
	                if(strpos($value, $parts[1]."/".$parts[2]) !== false) {
	                    $institutionsInTowns[] = $value;
	                }
	            }
	        }
	    }
	}
	
	foreach ($institutionsInTowns as $value) {
	    $recordKey = $institutionsMappings[md5($value)];
	    if (isset($records[$recordKey])) {
	        $tempKey = $institutionsMappings[md5($value)];
	        $tempValue = $records[$tempKey];
	        $tempArray[$tempKey] = $tempValue;
	        unset($records[$tempKey]);
	        $records = $tempArray + $records;
	    }
	}
	
	//
	
	if ($count <= 2) {
		$maxInstitutionsShown = 2;
	} else if ($count === 3) {
		$maxInstitutionsShown = 3;
	} else if ($count >= 4) {
		$maxInstitutionsShown = 2;
	}

	 $i = 0; // Print first $maxInstitutionsShown institutions
	 foreach ($records as $source => $value):
	    $i++;
		$record = $value['id'];
		$recordInLibraryOwnershipClass = is_array($this->myLibs) && in_array($source, $this->myLibs) ? 'my-library-record' : 'other-library-record';
		
		if ($this->params->getSearchType() == 'advanced') {
		    $recordUrl = $this->recordLink()->getUrl($record).'?fromAdvancedSearchId='.$this->results->getSearchId();
		} else {
		    $recordUrl = $this->recordLink()->getUrl($record).'?fromSearchId='.$this->results->getSearchId();
		}
		
		$anchor = $this->transEsc('source_' . $source, null, $source);
		
	?>

    <a href="<?=$recordUrl?>" title="<?=$this->translate('Record in institution') . ' ' . $anchor ?>">
        <div class="row root-title">
            <div class="col-sm-12">
                <span class="<?=$recordInLibraryOwnershipClass?>"><?=$anchor?></span>
            </div>
        </div>
    </a>

    <? if ($i == $maxInstitutionsShown) break; ?>
<? endforeach; ?>


<? if (count($records) > $maxInstitutionsShown): 
	// If there is more institutions than $maxInstitutionsShown, print Dropdown
?>
<div class="margin-bottom">
	<div class="btn-group">
        <span type="button" class="show-next-institutions dropdown-toggle" data-toggle="dropdown"><?=$this->translate('Show next institutions')?> <b class="caret"></b></span>
        <ul class="dropdown-menu scrollable-menu" role="menu">
            <?
                $i = 0;
                // print rest of institutions, to dropdown
                foreach ($records as $source => $value):
                $i++;
                if ($i <= $maxInstitutionsShown) continue;
                $record = $value['id'];
                $recordInLibraryOwnershipClass = is_array($this->myLibs) && in_array($source, $this->myLibs) ? 'my-library-record' : 'other-library-record';
                
                if ($this->params->getSearchType() == 'advanced') {
                    $recordUrl = $this->recordLink()->getUrl($record).'?fromAdvancedSearchId='.$this->results->getSearchId();
                } else {
                    $recordUrl = $this->recordLink()->getUrl($record).'?fromSearchId='.$this->results->getSearchId();
                }
                
                $anchor = $this->transEsc('source_' . $source, null, $source);
                
                ?>
            
                <a href="<?=$recordUrl?>" title="<?=$this->translate('Record in institution') . ' ' . $anchor ?>">
                    <div class="row root-title">
                        <div class="col-sm-12">
                            <span class="<?=$recordInLibraryOwnershipClass?>"><?=$anchor?></span>
                        </div>
                    </div>
                </a>
            
            <? endforeach; ?>
        </ul>
    </div>
</div>
<? endif; ?>

</div>
